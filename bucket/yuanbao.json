{
    "version": "2.33.1.612",
    "description": "Tencent Yuanbao desktop client powered by Hunyuan and DeepSeek models",
    "homepage": "https://yuanbao.tencent.com/evt/dl",
    "license": {
        "identifier": "Proprietary",
        "url": "https://privacy.qq.com/document/preview/eb9be56572ab4886b6ca124e72abf413"
    },
    "architecture": {
        "64bit": {
            "url": "https://cdn-hybrid-prod.hunyuan.tencent.com/Desktop/business/channels/yuanbao_7001_x64.exe#/dl.7z",
            "hash": "3421a68cb59442125becd001d7abbaa744a030139e650bb8366fbf0e400543a3"
        }
    },
    "installer": {
        "script": [
            "$appArchive = Get-ChildItem \"$dir\\install*.7z\" | Select-Object -First 1",
            "if (-not $appArchive) { throw 'Yuanbao app archive not found in installer package.' }",
            "Expand-7zipArchive $appArchive.FullName \"$dir\" -Removal",
            "@('$PLUGINSDIR', '$WINDIR', 'Yuanbao_new.exe', 'plugin_compress.ini') | ForEach-Object {",
            "    $path = Join-Path $dir $_",
            "    if (Test-Path $path) { Remove-Item $path -Recurse -Force }",
            "}"
        ]
    },
    "bin": "yuanbao.exe",
    "shortcuts": [
        [
            "yuanbao.exe",
            "Tencent Yuanbao"
        ]
    ],
    "checkver": {
        "url": "https://yuanbao.tencent.com/evt/dl",
        "script": [
            "$page = Invoke-WebRequest -Uri $url -UseBasicParsing",
            "$bundleUrlMatch = [regex]::Match($page.Content, 'https://cdn-bot\\.hunyuan\\.tencent\\.com/evt/dl/index\\.[a-z0-9]+\\.js')",
            "if (-not $bundleUrlMatch.Success) { throw 'Unable to locate Yuanbao download page bundle URL.' }",
            "$bundle = (Invoke-WebRequest -Uri $bundleUrlMatch.Value -UseBasicParsing).Content",
            "$pcChannelMatch = [regex]::Match($bundle, 'default:\\{[^}]{0,200}pc:\"(?<pc>\\d+)\"')",
            "if (-not $pcChannelMatch.Success) { throw 'Unable to parse default PC channel from Yuanbao bundle.' }",
            "$pcChannel = $pcChannelMatch.Groups['pc'].Value",
            "$pcUrlTemplateMatch = [regex]::Match($bundle, '(?<prefix>https://cdn-hybrid-prod\\.hunyuan\\.tencent\\.com/Desktop/business/channels/yuanbao_)\"\\.concat\\(t,\"(?<suffix>_x64\\.exe)\"\\)')",
            "if (-not $pcUrlTemplateMatch.Success) { throw 'Unable to parse PC download URL template from Yuanbao bundle.' }",
            "$downloadUrl = $pcUrlTemplateMatch.Groups['prefix'].Value + $pcChannel + $pcUrlTemplateMatch.Groups['suffix'].Value",
            "$pkgSchemaMatch = [regex]::Match($bundle, 'schemaid=(?<schema>yuanbao_evt_dl_pkg_ch_info_(?:prod|test))&schemakey=(?<key>[0-9a-f]+)')",
            "if ($pkgSchemaMatch.Success) {",
            "    $pkgSchemaUrl = 'https://cache.wuji.qq.com/x/api/wuji_cache/object?appid=yuanbao_evt&schemaid=' + $pkgSchemaMatch.Groups['schema'].Value + '&schemakey=' + $pkgSchemaMatch.Groups['key'].Value + '&page=1&size=500'",
            "    $pkgSchema = Invoke-WebRequest -Uri $pkgSchemaUrl -UseBasicParsing | ConvertFrom-Json",
            "    $override = $pkgSchema.data | Where-Object { $_.device -eq 'pc' -and $_.pkg_ch_id -eq $pcChannel } | Select-Object -First 1",
            "    if ($override -and $override.page_config) {",
            "        $pageConfig = $override.page_config | ConvertFrom-Json",
            "        if ($pageConfig.winDownloadLink) { $downloadUrl = $pageConfig.winDownloadLink }",
            "    }",
            "}",
            "$tmpFile = Join-Path $env:TEMP ('yuanbao_' + [guid]::NewGuid().ToString() + '.exe')",
            "try {",
            "    Invoke-WebRequest -Uri $downloadUrl -UseBasicParsing -OutFile $tmpFile",
            "    $version = (Get-Item $tmpFile).VersionInfo.FileVersion",
            "    if (-not $version) { throw 'Unable to read Yuanbao version from installer metadata.' }",
            "    Write-Output ($downloadUrl + '|' + $version)",
            "}",
            "finally {",
            "    if (Test-Path $tmpFile) { Remove-Item $tmpFile -Force -ErrorAction SilentlyContinue }",
            "}"
        ],
        "regex": "^(?<url>.+)\\|(?<version>[\\d.]+)$"
    },
    "autoupdate": {
        "architecture": {
            "64bit": {
                "url": "$matchUrl#/dl.7z"
            }
        }
    },
    "post_install": [
        "#region scoop-portable-profile",
        "# Portable profile helpers for Scoop manifests.",
        "# 说明：构建阶段会把该文件的内容内联进 post_install/pre_uninstall。",
        "function Resolve-PortablePath {",
        "    param(",
        "        [string]$Path,",
        "        [hashtable]$Context",
        "    )",
        "    if ($Path -match '^AppData/(.+)$') {",
        "        return (Join-Path $env:AppData $matches[1])",
        "    }",
        "    elseif ($Path -match '^LocalAppData/(.+)$') {",
        "        return (Join-Path $env:LocalAppData $matches[1])",
        "    }",
        "    elseif ($Path -match '^ProgramData/(.+)$') {",
        "        return (Join-Path $env:ProgramData $matches[1])",
        "    }",
        "    elseif ($Path -match '^UserProfile/(.+)$') {",
        "        return (Join-Path $env:USERPROFILE $matches[1])",
        "    }",
        "    elseif ($Path -match '^\\$dir(?<rest>[/\\\\].*)?$') {",
        "        $suffix = $matches['rest']",
        "        if ($suffix) {",
        "            $suffix = ($suffix -replace '^[/\\\\]+', '')",
        "            $suffix = $suffix.Replace('/', '\\\\')",
        "        }",
        "        return (Join-Path $Context.Dir $suffix)",
        "    }",
        "    elseif ($Path -match '^\\$persist_dir(?<rest>[/\\\\].*)?$') {",
        "        $suffix = $matches['rest']",
        "        if ($suffix) {",
        "            $suffix = ($suffix -replace '^[/\\\\]+', '')",
        "            $suffix = $suffix.Replace('/', '\\\\')",
        "        }",
        "        return (Join-Path $Context.PersistDir $suffix)",
        "    }",
        "    else {",
        "        return ($ExecutionContext.InvokeCommand.ExpandString($Path))",
        "    }",
        "}",
        "function Ensure-PortableDirectory {",
        "    param([string]$Path)",
        "    if (-not (Test-Path $Path)) {",
        "        New-Item -ItemType Directory -Path $Path -Force | Out-Null",
        "    }",
        "}",
        "function Ensure-PortableFile {",
        "    param([string]$Path)",
        "    $parent = Split-Path -Parent $Path",
        "    if ($parent) { Ensure-PortableDirectory $parent }",
        "    if (-not (Test-Path $Path)) {",
        "        New-Item -ItemType File -Path $Path -Force | Out-Null",
        "    }",
        "}",
        "function Copy-PortableData {",
        "    param(",
        "        [string]$Source,",
        "        [string]$Destination",
        "    )",
        "    if (Test-Path $Source) {",
        "        Ensure-PortableDirectory $Destination",
        "        Copy-Item \"$Source\\*\" $Destination -Force -Recurse -ErrorAction SilentlyContinue",
        "    }",
        "}",
        "function New-PortableSymlink {",
        "    param(",
        "        [string]$Link,",
        "        [string]$Target",
        "    )",
        "    if (Test-Path $Link) {",
        "        $item = Get-Item $Link -ErrorAction SilentlyContinue",
        "        if ($item -and $item.LinkType -and $item.Target -eq $Target) {",
        "            return",
        "        }",
        "        Remove-Item $Link -Recurse -Force -ErrorAction SilentlyContinue",
        "    }",
        "    New-Item -ItemType SymbolicLink -Path $Link -Target $Target -Force | Out-Null",
        "}",
        "function Remove-PortableLink {",
        "    param(",
        "        [string]$Link,",
        "        [switch]$Log",
        "    )",
        "    if (Test-Path $Link) {",
        "        $item = Get-Item $Link -ErrorAction SilentlyContinue",
        "        if ($item -and $item.LinkType) {",
        "            Remove-Item $Link -Force -ErrorAction SilentlyContinue",
        "            if ($Log) {",
        "                info \"[Portable Mode] Removed symbolic link: $Link\"",
        "            }",
        "        }",
        "    }",
        "}",
        "function Invoke-PortableMappings {",
        "    param(",
        "        [ValidateSet('Install', 'Uninstall')] [string]$Action,",
        "        [hashtable]$Context,",
        "        [array]$Mappings,",
        "        [switch]$Log",
        "    )",
        "    foreach ($mapping in $Mappings) {",
        "        $sourcePath = Resolve-PortablePath -Path $mapping.Source -Context $Context",
        "        $targetPath = Resolve-PortablePath -Path $mapping.Target -Context $Context",
        "        $targetType = if ($mapping.TargetType) { $mapping.TargetType } else { 'directory' }",
        "        if ($Action -eq 'Install') {",
        "            if ($mapping.EnsureTarget) {",
        "                if ($targetType -eq 'file') {",
        "                    Ensure-PortableFile $targetPath",
        "                }",
        "                else {",
        "                    Ensure-PortableDirectory $targetPath",
        "                }",
        "            }",
        "            if ($targetType -ne 'file') {",
        "                if ((Test-Path $sourcePath) -and -not (Get-Item $sourcePath -ErrorAction SilentlyContinue).LinkType) {",
        "                    Copy-PortableData -Source $sourcePath -Destination $targetPath",
        "                    Remove-Item $sourcePath -Recurse -Force -ErrorAction SilentlyContinue",
        "                }",
        "            }",
        "            elseif ((Test-Path $sourcePath) -and -not (Get-Item $sourcePath -ErrorAction SilentlyContinue).LinkType) {",
        "                Remove-Item $sourcePath -Recurse -Force -ErrorAction SilentlyContinue",
        "            }",
        "            switch ($mapping.Strategy) {",
        "                'symlink' { New-PortableSymlink -Link $sourcePath -Target $targetPath }",
        "                Default { Copy-PortableData -Source $sourcePath -Destination $targetPath }",
        "            }",
        "            if ($Log) {",
        "                info \"[Portable Mode] Linked $($mapping.Label) -> $targetPath\"",
        "            }",
        "        }",
        "        else {",
        "            Remove-PortableLink -Link $sourcePath -Log:$Log",
        "        }",
        "    }",
        "}",
        "#endregion",
        "Invoke-PortableMappings -Action Install -Context @{ Dir = $dir; PersistDir = $persist_dir } -Mappings @(",
        "    @{ Label = 'roaming'; Source = 'AppData/Tencent/yuanbao'; Target = \"$persist_dir/roaming\"; Strategy = 'symlink'; EnsureTarget = $true; TargetType = 'directory' },",
        "    @{ Label = 'local'; Source = 'LocalAppData/com.tencent.yuanbao'; Target = \"$persist_dir/local\"; Strategy = 'symlink'; EnsureTarget = $true; TargetType = 'directory' }",
        ") -Log:$true"
    ],
    "pre_uninstall": [
        "#region scoop-portable-profile",
        "# Portable profile helpers for Scoop manifests.",
        "# 说明：构建阶段会把该文件的内容内联进 post_install/pre_uninstall。",
        "function Resolve-PortablePath {",
        "    param(",
        "        [string]$Path,",
        "        [hashtable]$Context",
        "    )",
        "    if ($Path -match '^AppData/(.+)$') {",
        "        return (Join-Path $env:AppData $matches[1])",
        "    }",
        "    elseif ($Path -match '^LocalAppData/(.+)$') {",
        "        return (Join-Path $env:LocalAppData $matches[1])",
        "    }",
        "    elseif ($Path -match '^ProgramData/(.+)$') {",
        "        return (Join-Path $env:ProgramData $matches[1])",
        "    }",
        "    elseif ($Path -match '^UserProfile/(.+)$') {",
        "        return (Join-Path $env:USERPROFILE $matches[1])",
        "    }",
        "    elseif ($Path -match '^\\$dir(?<rest>[/\\\\].*)?$') {",
        "        $suffix = $matches['rest']",
        "        if ($suffix) {",
        "            $suffix = ($suffix -replace '^[/\\\\]+', '')",
        "            $suffix = $suffix.Replace('/', '\\\\')",
        "        }",
        "        return (Join-Path $Context.Dir $suffix)",
        "    }",
        "    elseif ($Path -match '^\\$persist_dir(?<rest>[/\\\\].*)?$') {",
        "        $suffix = $matches['rest']",
        "        if ($suffix) {",
        "            $suffix = ($suffix -replace '^[/\\\\]+', '')",
        "            $suffix = $suffix.Replace('/', '\\\\')",
        "        }",
        "        return (Join-Path $Context.PersistDir $suffix)",
        "    }",
        "    else {",
        "        return ($ExecutionContext.InvokeCommand.ExpandString($Path))",
        "    }",
        "}",
        "function Ensure-PortableDirectory {",
        "    param([string]$Path)",
        "    if (-not (Test-Path $Path)) {",
        "        New-Item -ItemType Directory -Path $Path -Force | Out-Null",
        "    }",
        "}",
        "function Ensure-PortableFile {",
        "    param([string]$Path)",
        "    $parent = Split-Path -Parent $Path",
        "    if ($parent) { Ensure-PortableDirectory $parent }",
        "    if (-not (Test-Path $Path)) {",
        "        New-Item -ItemType File -Path $Path -Force | Out-Null",
        "    }",
        "}",
        "function Copy-PortableData {",
        "    param(",
        "        [string]$Source,",
        "        [string]$Destination",
        "    )",
        "    if (Test-Path $Source) {",
        "        Ensure-PortableDirectory $Destination",
        "        Copy-Item \"$Source\\*\" $Destination -Force -Recurse -ErrorAction SilentlyContinue",
        "    }",
        "}",
        "function New-PortableSymlink {",
        "    param(",
        "        [string]$Link,",
        "        [string]$Target",
        "    )",
        "    if (Test-Path $Link) {",
        "        $item = Get-Item $Link -ErrorAction SilentlyContinue",
        "        if ($item -and $item.LinkType -and $item.Target -eq $Target) {",
        "            return",
        "        }",
        "        Remove-Item $Link -Recurse -Force -ErrorAction SilentlyContinue",
        "    }",
        "    New-Item -ItemType SymbolicLink -Path $Link -Target $Target -Force | Out-Null",
        "}",
        "function Remove-PortableLink {",
        "    param(",
        "        [string]$Link,",
        "        [switch]$Log",
        "    )",
        "    if (Test-Path $Link) {",
        "        $item = Get-Item $Link -ErrorAction SilentlyContinue",
        "        if ($item -and $item.LinkType) {",
        "            Remove-Item $Link -Force -ErrorAction SilentlyContinue",
        "            if ($Log) {",
        "                info \"[Portable Mode] Removed symbolic link: $Link\"",
        "            }",
        "        }",
        "    }",
        "}",
        "function Invoke-PortableMappings {",
        "    param(",
        "        [ValidateSet('Install', 'Uninstall')] [string]$Action,",
        "        [hashtable]$Context,",
        "        [array]$Mappings,",
        "        [switch]$Log",
        "    )",
        "    foreach ($mapping in $Mappings) {",
        "        $sourcePath = Resolve-PortablePath -Path $mapping.Source -Context $Context",
        "        $targetPath = Resolve-PortablePath -Path $mapping.Target -Context $Context",
        "        $targetType = if ($mapping.TargetType) { $mapping.TargetType } else { 'directory' }",
        "        if ($Action -eq 'Install') {",
        "            if ($mapping.EnsureTarget) {",
        "                if ($targetType -eq 'file') {",
        "                    Ensure-PortableFile $targetPath",
        "                }",
        "                else {",
        "                    Ensure-PortableDirectory $targetPath",
        "                }",
        "            }",
        "            if ($targetType -ne 'file') {",
        "                if ((Test-Path $sourcePath) -and -not (Get-Item $sourcePath -ErrorAction SilentlyContinue).LinkType) {",
        "                    Copy-PortableData -Source $sourcePath -Destination $targetPath",
        "                    Remove-Item $sourcePath -Recurse -Force -ErrorAction SilentlyContinue",
        "                }",
        "            }",
        "            elseif ((Test-Path $sourcePath) -and -not (Get-Item $sourcePath -ErrorAction SilentlyContinue).LinkType) {",
        "                Remove-Item $sourcePath -Recurse -Force -ErrorAction SilentlyContinue",
        "            }",
        "            switch ($mapping.Strategy) {",
        "                'symlink' { New-PortableSymlink -Link $sourcePath -Target $targetPath }",
        "                Default { Copy-PortableData -Source $sourcePath -Destination $targetPath }",
        "            }",
        "            if ($Log) {",
        "                info \"[Portable Mode] Linked $($mapping.Label) -> $targetPath\"",
        "            }",
        "        }",
        "        else {",
        "            Remove-PortableLink -Link $sourcePath -Log:$Log",
        "        }",
        "    }",
        "}",
        "#endregion",
        "Invoke-PortableMappings -Action Uninstall -Context @{ Dir = $dir; PersistDir = $persist_dir } -Mappings @(",
        "    @{ Label = 'roaming'; Source = 'AppData/Tencent/yuanbao'; Target = \"$persist_dir/roaming\"; Strategy = 'symlink'; EnsureTarget = $true; TargetType = 'directory' },",
        "    @{ Label = 'local'; Source = 'LocalAppData/com.tencent.yuanbao'; Target = \"$persist_dir/local\"; Strategy = 'symlink'; EnsureTarget = $true; TargetType = 'directory' }",
        ") -Log:$true"
    ]
}
